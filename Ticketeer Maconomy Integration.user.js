// ==UserScript==
// @name         Ticketeer Timesheet Integration Dev
// @namespace    my.Home
// @version      1.0
// @description  Makes your life better one friday at a time
// @author       Tommy Svenningsson
// @grant        none
// @match       https://ter.istone.com/cgi-bin/Maconomy/*
// @require      https://code.jquery.com/jquery-3.1.1.min.js
// ==/UserScript==

var apiKey = '';
var user = '';
var pass = '';
var debug = false;
function checkDOMChange(){for(var a=0;a<window.frames.length;a++)!function(a){"componentframe"==a.getAttribute("name")&&(doc=$(a.contentDocument||a.contentWindow.document),scrapeDates(a))}(window.frames[a].frameElement)}function scrapeDates(a){var c=(doc.find("#timeSheetTable"),doc.find("#calendar"));c.bind("DOMSubtreeModified",function(){if(c.find("span.selected")[0]){var a=c.find("span.selected span").attr("onclick").match(/.*?(\d+\.\d+\.\d+).*?/)[1].replace(/[.]/g,"-"),b=c.find("span.selected").parent().siblings().last().find(".clickable").attr("onclick").match(/.*?(\d+\.\d+\.\d+).*?/)[1].replace(/[.]/g,"-");loadTimers(a,b),weekDates=getDates(new Date(a),new Date(b))}})}function getFormatedDate(a){var b=a.getDate(),c=a.getMonth()+1,d=a.getFullYear();b<10&&(b="0"+b),c<10&&(c="0"+c);var e=d+"-"+c+"-"+b;return e}function getDates(a,b){for(var c=new Array,d=a;d<=b;)c.push(getFormatedDate(d)),d=d.addDays(1);return c}function loadTimers(a,b){$.ajax({type:"POST",url:"https://www.ticketeer.se/api/get_time_report",dataType:"json",data:{key:apiKey,fromDate:a,toDate:b},beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(user+":"+pass))},success:function(a){if(doc.find("#updateTimes").parent().parent().remove(),a.length>0){var b=0;ticketeerTimers=sortJsonArray(a,"task_id"),$.each(a,function(a,c){b+=c.hours});var c='<td class="button"><div><input type="button" id="updateTimes" value="Add '+b+' hours from ticketeer"></div></td>';doc.find(".innerArea .buttonsTop .button").parent().append(c),doc.find("#updateTimes").on("click",function(){$(this).prop("value","Working, please don't touch anything"),$(this).prop("disabled",!0),addedTimeIds=new Array,populateTimesheet(0,null)})}}})}function populateTimesheet(a,b){var c=doc.find("#timeSheetTable"),d=c.find("th.rowAction .button");if(echo(c),echo(d),echo(ticketeerTimers),a<ticketeerTimers.length)if(timer=ticketeerTimers[a],timer.task_id==b){echo("Adding time to same row");var e=doc.find("#timeSheetTable tr.selected").children();if(echo(e),e.length>0){var f=$.inArray(timer.date,weekDates);$(e[5+f]).find("input").val(timer.hours),$(e[5+f]).find("input").attr("title",timer.hours),$(e[16]).find("input").val(timer.task_name),addedTimeIds.push(timer.id),checkTimer(timer.id)}populateTimesheet(a+1,timer.task_id)}else echo("Adding new row for task_id:"+timer.task_id),d.trigger("click"),doc.one("focus","input",function(){var b=$(this);if(echo(b),b[0]){b.attr("title",timer.board_name),b.val(timer.board_name);var c=$.Event("keypress");c.which=13,setTimeout(function(){b.trigger(c),doc.one("DOMSubtreeModified","#timeSheetTable",function(){setTimeout(function(){var b=doc.find("#timeSheetTable tr.selected").children();if(b.length>0){var c=$.inArray(timer.date,weekDates);$(b[5+c]).find("input").val(timer.hours),$(b[5+c]).find("input").attr("title",timer.hours),$(b[16]).find("input").val(timer.task_name),addedTimeIds.push(timer.id),checkTimer(timer.id)}populateTimesheet(a+1,timer.task_id)},100)})},100)}});else setTimeout(function(){alert(addedTimeIds.length+" of "+ticketeerTimers.length+" entries successfully added!")},100),echo(addedTimeIds),doc.find("#updateTimes").parent().parent().remove()}function checkTimer(a){$.ajax({type:"POST",url:"https://www.ticketeer.se/api/check_timer",dataType:"json",data:{key:apiKey,timerId:a},beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(user+":"+pass))},success:function(a){echo(a)}})}function echo(a){debug&&console.log(a)}function sortJsonArray(a,b){return a=a.sort(function(a,c){return c[b]>a[b]?1:c[b]<a[b]?-1:0})}var ticketeerTimers,doc,weekDates,addedTimeIds;window.onload=function(){""!==apiKey&&checkDOMChange()},Date.prototype.addDays=function(a){var b=new Date(this.valueOf());return b.setDate(b.getDate()+a),b};